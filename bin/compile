#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

BUILD_DIR=$1
CACHE_DIR=$2
ENV_DIR=$3

# Function to write env vars to a temporary file for sourcing
write_env_file() {
  local env_file="$1"
  if [ -d "$ENV_DIR" ]; then
    for e in $(ls $ENV_DIR); do
      if [[ $e == WEB_* ]]; then
        # Remove WEB_ prefix
        local var_name=${e#WEB_}
        # Read the value preserving all special characters
        local value=$(cat "$ENV_DIR/$e")
        # Write export statement to file, properly escaping the value
        printf "export %s=%q\n" "$var_name" "$value" >> "$env_file"
        # Print debug info
        echo "-----> Setting $var_name for build" | indent
      fi
    done
  fi
}

cleanup() {
  STAGE="$(mktemp -d)"
  # Move the api directory to the root
  echo "Moving api/ staging area"
  mv "${BUILD_DIR}/api" "${STAGE}/"

  echo "Creating web/ staging area"
  mkdir -p "${STAGE}/web"

  echo "Moving build web build dirs into to web/ staging area"
  mv "${BUILD_DIR}/dist" "${STAGE}/web/"
  mv "${BUILD_DIR}/bin" "${STAGE}/web/"
  mv "${BUILD_DIR}/public" "${STAGE}/web/"

  echo "Removing all contents from root"
  rm -rf "${BUILD_DIR}"/*

  echo "Copying contents of web/ to root of app directory"
  mv "${STAGE}/api"/* "${BUILD_DIR}"
}

echo "-----> Frontend Buildpack: Starting build process"

cd $BUILD_DIR

# Calculate checksum using the existing script
echo "-----> Calculating web directory checksum"
WEB_CHECKSUM=$(bash ./bin/sha-files | tail -n 1)
echo "-----> Current checksum: $WEB_CHECKSUM" | indent

# Check if this build already exists in cache
CACHED_BUILD_DIR="$CACHE_DIR/web-builds/$WEB_CHECKSUM"

if [ -d "$CACHED_BUILD_DIR" ] && [ -d "$CACHED_BUILD_DIR/dist" ]; then
  echo "-----> Build found in cache, using cached version"
  echo "-----> Cached build exists, skipping rebuild"
  # Copy dist back into web/
  cp -r "$CACHED_BUILD_DIR/dist" "$BUILD_DIR/"
  echo "-----> Frontend build complete (from cache)"

  cleanup
  exit 0
fi

echo "-----> No cached build found, proceeding with fresh build"

# Prepare WEB_ environment variables for build
echo "-----> Preparing WEB_ environment variables for build"

# Create a temporary file for environment variables
ENV_FILE=$(mktemp)
trap "rm -f $ENV_FILE" EXIT

# Write all WEB_ variables to the temp file
write_env_file "$ENV_FILE"

# Increase Node.js memory limit for the build
echo "export NODE_OPTIONS='--max-old-space-size=4096'" >> "$ENV_FILE"
echo "-----> Setting NODE_OPTIONS=--max-old-space-size=4096" | indent

# Build the frontend in a subshell with the isolated environment
echo "-----> Building frontend application"
(
  source "$ENV_FILE"
  npm run build 2>&1 | indent
)

# Cache the build
echo "-----> Caching build for future deployments"
mkdir -p "$CACHED_BUILD_DIR"
cp -r dist "$CACHED_BUILD_DIR/"

cleanup

echo "-----> Frontend build complete"
